name: Deploy FastAPI and React to Local Machine

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ============================================
      # BACKEND (FastAPI) DEPLOYMENT
      # ============================================

      - name: Install Backend Dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        shell: powershell

      - name: Stop existing FastAPI process
        run: |
          # Stop Task Scheduler task first
          Stop-ScheduledTask -TaskName "FastAPI_App" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          # Kill all python processes running uvicorn
          $processes = Get-WmiObject Win32_Process -Filter "name = 'python.exe'" | Where-Object {
            $_.CommandLine -like "*uvicorn*"
          }
          
          foreach ($proc in $processes) {
            Write-Host "Stopping process ID: $($proc.ProcessId) - $($proc.CommandLine)"
            Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue
          }
          
          Start-Sleep -Seconds 2
          Write-Host "All FastAPI processes stopped"
        shell: powershell
        continue-on-error: true

      - name: Start FastAPI application as background service
        run: |
          $backendPath = Join-Path -Path "${{ github.workspace }}" -ChildPath "backend"
          
          # Create action with Hidden window
          $action = New-ScheduledTaskAction -Execute "python" -Argument "-m uvicorn main:app --host 0.0.0.0 --port 8000" -WorkingDirectory $backendPath
          
          # Trigger to start immediately
          $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(5)
          
          # Settings to run hidden in background
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -Hidden
          
          # Principal to run without user interaction
          $principal = New-ScheduledTaskPrincipal -UserId "$env:USERNAME" -LogonType S4U -RunLevel Highest
          
          # Unregister existing task
          Unregister-ScheduledTask -TaskName "FastAPI_App" -Confirm:$false -ErrorAction SilentlyContinue
          
          # Register new task
          Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "FastAPI_App" -Settings $settings -Principal $principal -Force
          
          # Start the task
          Start-ScheduledTask -TaskName "FastAPI_App"
          Start-Sleep -Seconds 5
          
          Write-Host "FastAPI started in background (no window)"
        shell: powershell

      - name: Wait for FastAPI to be ready
        run: |
          $maxAttempts = 30
          $attempt = 0
          do {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8000" -TimeoutSec 2 -UseBasicParsing
              Write-Host "FastAPI is ready!"
              break
            } catch {
              $attempt++
              Write-Host "Waiting for FastAPI... Attempt $attempt"
              Start-Sleep -Seconds 2
            }
          } while ($attempt -lt $maxAttempts)
        shell: powershell

      - name: FastAPI Health check
        run: |
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8000" -UseBasicParsing
            Write-Host "FastAPI Health check passed - Status: $($response.StatusCode)"
          } catch {
            Write-Host "FastAPI Health check failed: $_"
            exit 1
          }
        shell: powershell

      # ============================================
      # FRONTEND (React) DEPLOYMENT
      # ============================================

      - name: Verify Node.js Installation
        run: |
          Write-Host "Node version: $(node --version)"
          Write-Host "NPM version: $(npm --version)"
        shell: powershell

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
        shell: powershell

      - name: Build React Application
        run: |
          cd frontend
          npm run build
        shell: powershell
        env:
          CI: false

      - name: Stop existing React process
        run: |
          # Stop Task Scheduler task first
          Stop-ScheduledTask -TaskName "React_App" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          # Kill all node processes running serve
          $processes = Get-WmiObject Win32_Process -Filter "name = 'node.exe'" | Where-Object {
            $_.CommandLine -like "*serve*"
          }
          
          foreach ($proc in $processes) {
            Write-Host "Stopping process ID: $($proc.ProcessId) - $($proc.CommandLine)"
            Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue
          }
          
          Start-Sleep -Seconds 2
          Write-Host "All React serve processes stopped"
        shell: powershell
        continue-on-error: true

      - name: Install serve globally (if not installed)
        run: |
          $serveInstalled = npm list -g serve 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "serve not found, installing..."
            npm install -g serve
          } else {
            Write-Host "serve is already installed"
          }
        shell: powershell
        continue-on-error: true

      - name: Start React application as background service
        run: |
          $frontendPath = Join-Path -Path "${{ github.workspace }}" -ChildPath "frontend"
          
          # Create action with Hidden window
          $action = New-ScheduledTaskAction -Execute "serve" -Argument "-s build -l 3000" -WorkingDirectory $frontendPath
          
          # Trigger to start immediately
          $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(5)
          
          # Settings to run hidden in background
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -Hidden
          
          # Principal to run without user interaction
          $principal = New-ScheduledTaskPrincipal -UserId "$env:USERNAME" -LogonType S4U -RunLevel Highest
          
          # Unregister existing task
          Unregister-ScheduledTask -TaskName "React_App" -Confirm:$false -ErrorAction SilentlyContinue
          
          # Register new task
          Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "React_App" -Settings $settings -Principal $principal -Force
          
          # Start the task
          Start-ScheduledTask -TaskName "React_App"
          Start-Sleep -Seconds 10
          
          Write-Host "React app started in background (no window)"
        shell: powershell

      - name: Wait for React app to be ready
        run: |
          $maxAttempts = 30
          $attempt = 0
          do {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:3000" -TimeoutSec 2 -UseBasicParsing
              Write-Host "React app is ready!"
              break
            } catch {
              $attempt++
              Write-Host "Waiting for React app... Attempt $attempt"
              Start-Sleep -Seconds 2
            }
          } while ($attempt -lt $maxAttempts)
        shell: powershell

      - name: React Health check
        run: |
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:3000" -UseBasicParsing
            Write-Host "React Health check passed - Status: $($response.StatusCode)"
          } catch {
            Write-Host "React Health check failed: $_"
            exit 1
          }
        shell: powershell

      - name: Deployment Summary
        run: |
          Write-Host "================================"
          Write-Host "Deployment Successful!"
          Write-Host "================================"
          Write-Host "FastAPI Backend: http://localhost:8000"
          Write-Host "React Frontend: http://localhost:3000"
          Write-Host "================================"
        shell: powershell